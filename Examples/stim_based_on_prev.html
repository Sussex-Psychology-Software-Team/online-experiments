<!DOCTYPE html>
<html>

<head>
    <!-- Title shown in tab -->
    <title>Experiment</title>

    <!-- Load JsPsych -->
    <script src="https://unpkg.com/jspsych@7.3.1"></script>
    <link href="https://unpkg.com/jspsych@7.3.1/css/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
</head>

<body></body>

<script>
    var jsPsych = initJsPsych({
        on_finish: function () {
            jsPsych.data.displayData("json") // Display data in browser
        }
    })

    var timeline = []

    var stimuli_all = ["ONE", "TWO", "THREE"]

    var instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "BLABLA INSTRUCTIONS",
        // CREATE NEW STIMULUS LIST AFTER THIS STAGE
        on_finish: function () {
            var stimuli_new = ["ONE", "TWO"]
            jsPsych.data.addProperties({stimuli_new}) // add this to all trials (i.e. only this one at this point)
        }
    }
    timeline.push(instructions)

    // TRIALS
    var trial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: jsPsych.timelineVariable('stimulus'),
    }

    for(let i=0; i<stimuli_all.length; i++){ // KEEP THIS AS LET AND NOT VAR
        var trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: stimuli_all[i]
        }

        var newNode = {
            timeline: [trial],
            conditional_function: function(){ // Evaluated only at the start of trials
                // stimuli_new is in every trial, just grab it from the first one here
                var data = jsPsych.data.get().trials[0].stimuli_new;
                console.log(data)
                if(data.includes(stimuli_all[i])){ // check stimuli new includes the current stimulus
                        return true; // continue
                    } else {
                        return false;
                    }
                }
        }

        timeline.push(newNode)
    }

    jsPsych.run(timeline)

</script>

</html>